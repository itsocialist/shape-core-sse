<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Ship APE Core SSE • Admin Utility</title>
  <style>
    :root { --bg:#0b1020; --panel:#111936; --muted:#8aa0bf; --text:#eaf1ff; --accent:#6ea8fe; --ok:#27ae60; --err:#e74c3c; }
    body { margin:0; font:14px/1.4 -apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Inter,system-ui; background:var(--bg); color:var(--text); }
    header { padding:18px 20px; background:#0e1530; border-bottom:1px solid #1a2447; position:sticky; top:0; z-index:1; }
    h1 { margin:0; font-size:18px; letter-spacing:.2px; }
    main { max-width:1100px; margin:18px auto; padding:0 20px 40px; }
    .grid { display:grid; grid-template-columns: 1fr 1fr; gap:16px; }
    @media (max-width: 980px) { .grid { grid-template-columns:1fr; } }
    .panel { background:var(--panel); border:1px solid #1a2447; border-radius:10px; padding:16px; }
    .panel h2 { margin:0 0 10px; font-size:16px; }
    .row { display:flex; gap:8px; margin:8px 0; }
    .row > * { flex:1; }
    label { font-size:12px; color:var(--muted); display:block; margin-bottom:6px; }
    input, select, textarea { width:100%; box-sizing:border-box; padding:9px 10px; border-radius:8px; border:1px solid #22305f; background:#0e1631; color:var(--text); }
    button { background:var(--accent); color:#001028; border:none; border-radius:8px; padding:10px 12px; font-weight:600; cursor:pointer; }
    button.ghost { background:transparent; color:var(--accent); border:1px solid var(--accent); }
    .muted { color:var(--muted); font-size:12px; }
    .ok { color:var(--ok); }
    .err { color:var(--err); }
    .log { background:#0d142e; border:1px solid #1a2447; border-radius:10px; padding:10px; height:240px; overflow:auto; font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; font-size:12px; }
    .sse { height:180px; }
    .badge { display:inline-block; padding:2px 6px; border:1px solid #30427a; border-radius:999px; color:#a6bee5; font-size:11px; }
  </style>
</head>
<body>
  <header>
    <h1>Ship APE Core SSE • Admin Utility</h1>
    <div class="muted">Create tenants, manage keys, and test MCP/SSE.</div>
  </header>
  <main>
    <div class="panel">
      <h2>Configuration</h2>
      <div class="grid">
        <div>
          <label>Base URL</label>
          <input id="baseUrl" value="https://ship-ape-sse-production.up.railway.app" />
          <div class="row">
            <button onclick="useRailway()">Use Railway</button>
            <button class="ghost" onclick="useLocal()">Use Local</button>
          </div>
          <div class="muted">Endpoints: /health, /tenant/register, /mcp, /mcp/sse, /.well-known/*</div>
        </div>
        <div>
          <label>Master Key (X-Master-Key)</label>
          <input id="masterKey" placeholder="enter SHIP_APE_MASTER_KEY" />
          <div class="muted">Required for admin endpoints (create/list/rotate/delete tenants)</div>
        </div>
      </div>
    </div>

    <div class="grid">
      <div class="panel">
        <h2>Health & Metadata</h2>
        <div class="row">
          <button onclick="health()">GET /health</button>
          <button class="ghost" onclick="oauthAS()">.well-known/oauth-authorization-server</button>
        </div>
        <div class="row">
          <button class="ghost" onclick="oauthResource()">.well-known/oauth-protected-resource</button>
          <button class="ghost" onclick="oauthResourceMcp()">.well-known/oauth-protected-resource/mcp</button>
        </div>
        <div id="metaLog" class="log"></div>
      </div>

      <div class="panel">
        <h2>Tenants</h2>
        <div class="row">
          <div>
            <label>Tenant ID (optional)</label>
            <input id="tenantId" placeholder="my-tenant" />
          </div>
          <div>
            <label>Permissions (csv)</label>
            <input id="perms" value="read,write" />
          </div>
        </div>
        <div class="row">
          <button onclick="createTenant()">Create Tenant</button>
          <button class="ghost" onclick="listTenants()">List Tenants</button>
        </div>
        <div class="row">
          <div>
            <label>Rotate/Delete Tenant ID</label>
            <input id="tenantIdOps" placeholder="tenant-..." />
          </div>
        </div>
        <div class="row">
          <button class="ghost" onclick="rotateKey()">Rotate Key</button>
          <button class="ghost" onclick="deleteTenant()">Delete Tenant</button>
        </div>
        <div id="tenantLog" class="log"></div>
      </div>
    </div>

    <div class="grid">
      <div class="panel">
        <h2>MCP (HTTP)</h2>
        <div class="row">
          <div>
            <label>API Key (Bearer)</label>
            <input id="apiKey" placeholder="paste apiKey after create tenant" />
          </div>
        </div>
        <div class="row">
          <button onclick="mcpInit()">POST /mcp initialize</button>
          <button class="ghost" onclick="mcpTools()">POST /mcp tools/list</button>
        </div>
        <div id="mcpLog" class="log"></div>
      </div>

      <div class="panel">
        <h2>SSE</h2>
        <div class="row">
          <div>
            <label>Session ID</label>
            <input id="sessionId" value="admin-util-session" />
          </div>
          <div>
            <label>Connect</label>
            <button onclick="sseConnect()">Connect SSE</button>
            <button class="ghost" onclick="sseDisconnect()">Disconnect</button>
          </div>
        </div>
        <div class="muted">Uses query token: GET /mcp/sse?sessionId=...&access_token=apiKey</div>
        <div id="sseLog" class="log sse"></div>
      </div>
    </div>
  </main>

  <script>
    const $ = (id) => document.getElementById(id);
    const log = (el, msg, cls) => { const t = new Date().toLocaleTimeString(); el.innerHTML += `<div class="${cls||''}">[${t}] ${msg}</div>`; el.scrollTop = el.scrollHeight; };

    function useRailway(){ $('baseUrl').value = 'https://ship-ape-sse-production.up.railway.app'; }
    function useLocal(){ $('baseUrl').value = 'http://localhost:3000'; }

    async function jfetch(path, {method='GET', headers={}, body}={}){
      const url = new URL(path, $('baseUrl').value).toString();
      const res = await fetch(url, { method, headers, body });
      const ct = res.headers.get('content-type')||'';
      const data = ct.includes('application/json') ? await res.json() : await res.text();
      return { ok: res.ok, status: res.status, data, headers: res.headers, url };
    }

    // Health & Metadata
    async function health(){
      const out = $('metaLog'); out.innerHTML='';
      const r = await jfetch('/health');
      log(out, `GET /health -> ${r.status} ${r.ok? '✓':''}`); log(out, JSON.stringify(r.data, null, 2));
    }
    async function oauthAS(){ const out=$('metaLog'); const r=await jfetch('/.well-known/oauth-authorization-server'); log(out, `AuthZ metadata ${r.status}`); log(out, JSON.stringify(r.data, null, 2)); }
    async function oauthResource(){ const out=$('metaLog'); const r=await jfetch('/.well-known/oauth-protected-resource'); log(out, `Resource metadata ${r.status}`); log(out, JSON.stringify(r.data, null, 2)); }
    async function oauthResourceMcp(){ const out=$('metaLog'); const r=await jfetch('/.well-known/oauth-protected-resource/mcp'); log(out, `Resource MCP metadata ${r.status}`); log(out, JSON.stringify(r.data, null, 2)); }

    // Tenants
    async function createTenant(){
      const out=$('tenantLog'); const mk=$('masterKey').value.trim(); if(!mk){ log(out,'Provide master key','err'); return; }
      const tid = $('tenantId').value.trim(); const perms= $('perms').value.split(',').map(s=>s.trim()).filter(Boolean);
      const r = await jfetch('/tenant/register', { method:'POST', headers:{'Content-Type':'application/json','X-Master-Key':mk}, body: JSON.stringify({tenantId: tid||undefined, permissions: perms}) });
      log(out, `Create tenant -> ${r.status} ${r.ok? '✓':'✗'}`); log(out, JSON.stringify(r.data, null, 2));
      const apiKey = r?.data?.tenant?.apiKey; if(apiKey){ $('apiKey').value = apiKey; }
      if(r?.data?.tenant?.tenantId){ $('tenantIdOps').value = r.data.tenant.tenantId; }
    }
    async function listTenants(){
      const out=$('tenantLog'); const mk=$('masterKey').value.trim(); if(!mk){ log(out,'Provide master key','err'); return; }
      const r = await jfetch('/admin/tenants', { headers:{'X-Master-Key':mk} });
      log(out, `List tenants -> ${r.status}`); log(out, JSON.stringify(r.data, null, 2));
    }
    async function rotateKey(){
      const out=$('tenantLog'); const mk=$('masterKey').value.trim(); const tid=$('tenantIdOps').value.trim(); if(!mk||!tid){ log(out,'Need master key and tenantId','err'); return; }
      const r = await jfetch(`/admin/tenant/${encodeURIComponent(tid)}/rotate-key`, { method:'POST', headers:{'X-Master-Key':mk} });
      log(out, `Rotate key -> ${r.status}`); log(out, JSON.stringify(r.data, null, 2));
      const newKey = r?.data?.newApiKey; if(newKey){ $('apiKey').value = newKey; }
    }
    async function deleteTenant(){
      const out=$('tenantLog'); const mk=$('masterKey').value.trim(); const tid=$('tenantIdOps').value.trim(); if(!mk||!tid){ log(out,'Need master key and tenantId','err'); return; }
      const r = await jfetch(`/admin/tenant/${encodeURIComponent(tid)}`, { method:'DELETE', headers:{'X-Master-Key':mk} });
      log(out, `Delete tenant -> ${r.status}`); log(out, JSON.stringify(r.data, null, 2));
    }

    // MCP
    async function mcpInit(){
      const out=$('mcpLog'); const key=$('apiKey').value.trim(); if(!key){ log(out,'Provide API key','err'); return; }
      const r = await jfetch('/mcp', { method:'POST', headers:{'Content-Type':'application/json','Authorization':`Bearer ${key}`}, body: JSON.stringify({jsonrpc:'2.0', id: Date.now(), method:'initialize', params:{}})});
      log(out, `mcp initialize -> ${r.status}`); log(out, JSON.stringify(r.data, null, 2));
    }
    async function mcpTools(){
      const out=$('mcpLog'); const key=$('apiKey').value.trim(); if(!key){ log(out,'Provide API key','err'); return; }
      const r = await jfetch('/mcp', { method:'POST', headers:{'Content-Type':'application/json','Authorization':`Bearer ${key}`}, body: JSON.stringify({jsonrpc:'2.0', id: Date.now(), method:'tools/list', params:{}})});
      log(out, `mcp tools/list -> ${r.status}`); log(out, JSON.stringify(r.data, null, 2));
    }

    // SSE
    let es = null;
    function sseConnect(){
      const out=$('sseLog'); const key=$('apiKey').value.trim(); const sid=$('sessionId').value.trim()||`sess_${Date.now()}`; if(!key){ log(out,'Provide API key','err'); return; }
      const base = $('baseUrl').value.replace(/\/$/,'');
      const url = `${base}/mcp/sse?sessionId=${encodeURIComponent(sid)}&access_token=${encodeURIComponent(key)}`;
      log(out, `connecting ${url}`);
      if(es) es.close();
      es = new EventSource(url);
      es.onopen = () => log(out, 'open ✓', 'ok');
      es.onerror = (e) => log(out, 'error ✗', 'err');
      es.onmessage = (e) => { try { const d = JSON.parse(e.data); log(out, 'event: '+(d.type||'message')+ ' ' + JSON.stringify(d)); } catch { log(out, 'event: '+e.data); } };
    }
    function sseDisconnect(){ if(es){ es.close(); es=null; $('sseLog').innerHTML+='\n'; } }
  </script>
</body>
</html>

